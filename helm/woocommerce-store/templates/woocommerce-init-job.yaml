apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.storeName }}-wc-init
  namespace: store-{{ .Values.storeName }}
  labels:
    app: woocommerce-init
    store: {{ .Values.storeName }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 5
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: woocommerce-init
        store: {{ .Values.storeName }}
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-wordpress
          image: busybox:1.36
          resources:
            requests:
              memory: 32Mi
              cpu: 50m
            limits:
              memory: 64Mi
              cpu: 100m
          command:
            - sh
            - -c
            - |
              echo "Waiting for WordPress to be ready..."
              until wget -qO- --spider http://{{ .Values.storeName }}-wordpress/wp-login.php 2>/dev/null; do
                echo "WordPress not ready yet, retrying in 10s..."
                sleep 10
              done
              echo "WordPress is ready!"
      securityContext:
        runAsUser: 33
        runAsGroup: 33
        fsGroup: 33
      containers:
        - name: wc-setup
          image: {{ .Values.wordpress.cliImage }}
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 250m
          env:
            - name: WORDPRESS_DB_HOST
              value: {{ .Values.storeName }}-mariadb:3306
            - name: WORDPRESS_DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.storeName }}-db-secret
                  key: user
            - name: WORDPRESS_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.storeName }}-db-secret
                  key: password
            - name: WORDPRESS_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.storeName }}-db-secret
                  key: database
          command:
            - sh
            - -c
            - |
              set -e
              WP="wp --path=/var/www/html"

              echo "=== Installing WordPress Core ==="
              {{- if and .Values.storePort (ne (.Values.storePort | toString) "80") }}
              SITE_URL="http://{{ .Values.storeDomain }}:{{ .Values.storePort }}"
              {{- else }}
              SITE_URL="http://{{ .Values.storeDomain }}"
              {{- end }}
              $WP core install \
                --url="$SITE_URL" \
                --title="{{ .Values.storeName }} Store" \
                --admin_user="{{ .Values.wordpress.adminUser }}" \
                --admin_password="{{ .Values.wordpress.adminPassword }}" \
                --admin_email="{{ .Values.wordpress.adminEmail }}" \
                --skip-email

              echo "=== Installing WooCommerce ==="
              $WP plugin install woocommerce --activate

              echo "=== Configuring WooCommerce Settings ==="
              $WP option update woocommerce_store_address "123 Demo Street"
              $WP option update woocommerce_store_city "Demo City"
              $WP option update woocommerce_default_country "US:CA"
              $WP option update woocommerce_store_postcode "90210"
              $WP option update woocommerce_currency "USD"

              echo "=== Enabling Cash on Delivery ==="
              $WP option update woocommerce_cod_settings '{"enabled":"yes","title":"Cash on Delivery","description":"Pay with cash upon delivery.","instructions":"Pay with cash upon delivery."}' --format=json

              echo "=== Installing Storefront Theme ==="
              $WP theme install storefront --activate

              echo "=== Creating Sample Products ==="
              $WP wc product create \
                --name="Sample Product" \
                --type=simple \
                --regular_price="19.99" \
                --description="A sample product for testing your store." \
                --short_description="Sample product" \
                --status=publish \
                --user=1

              $WP wc product create \
                --name="Premium Widget" \
                --type=simple \
                --regular_price="49.99" \
                --description="A premium widget for discerning customers." \
                --short_description="Premium widget" \
                --status=publish \
                --user=1

              $WP wc product create \
                --name="Basic T-Shirt" \
                --type=simple \
                --regular_price="24.99" \
                --description="A comfortable basic t-shirt available in all sizes." \
                --short_description="Basic t-shirt" \
                --status=publish \
                --user=1

              echo "=== Setting Shop as Homepage ==="
              SHOP_PAGE_ID=$($WP option get woocommerce_shop_page_id)
              $WP option update show_on_front "page"
              $WP option update page_on_front "$SHOP_PAGE_ID"

              echo "=== Cleaning Up Defaults ==="
              $WP post delete 1 --force 2>/dev/null || true
              $WP post delete 2 --force 2>/dev/null || true
              $WP comment delete 1 --force 2>/dev/null || true

              echo "=== Skipping Onboarding Wizard ==="
              $WP option update woocommerce_onboarding_profile '{"completed":true}' --format=json || true
              $WP option update woocommerce_task_list_hidden "yes" 2>/dev/null || true

              echo "=== Flushing Rewrite Rules ==="
              $WP rewrite structure '/%postname%/'
              $WP rewrite flush

              echo "=== WooCommerce Setup Complete ==="
          volumeMounts:
            - name: wordpress-data
              mountPath: /var/www/html
      volumes:
        - name: wordpress-data
          persistentVolumeClaim:
            claimName: {{ .Values.storeName }}-wordpress-data
